<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Your Valentine</title>
  <meta name="description" content="A special Valentine experience">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Sacramento&display=swap" rel="stylesheet">
  <style>
    :root{
      --rose:#d4567f;
      --deep-rose:#a13d5f;
      --blush:#ffeef4;
      --cream:#fff9fc;
      --gold:#d4a574;
      --shadow:rgba(212,86,127,0.15);
      --pop-duration:520ms;
      --pop-ease:cubic-bezier(.2,.9,.25,1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html,body{
      height:100%;
      font-family:'Crimson Text',Georgia,serif;
      background: radial-gradient(ellipse at top, var(--blush), var(--cream));
      color:#2d1a24;
      overflow-x:hidden;
    }
    
    /* Floating hearts background */
    .hearts-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .heart-float {
      position: absolute;
      font-size: 20px;
      opacity: 0.1;
      animation: floatUp 15s infinite ease-in;
    }
    @keyframes floatUp {
      0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
      10% { opacity: 0.15; }
      90% { opacity: 0.05; }
      100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
    }
    
    .wrap{
      max-width:900px;
      margin:0 auto;
      padding:20px;
      position:relative;
      z-index:1;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }
    
    .card{
      background:rgba(255,255,255,0.85);
      backdrop-filter:blur(20px);
      border-radius:30px;
      padding:40px 30px;
      box-shadow:0 20px 60px var(--shadow), inset 0 1px 0 rgba(255,255,255,0.8);
      border:1px solid rgba(255,255,255,0.5);
      position:relative;
      overflow:hidden;
      opacity:0;
      animation:cardAppear 1s forwards 0.3s;
    }
    
    @keyframes cardAppear {
      to { opacity: 1; }
    }
    
    .card::before {
      content:'';
      position:absolute;
      top:-50%;
      left:-50%;
      width:200%;
      height:200%;
      background: radial-gradient(circle, rgba(212,86,127,0.03) 0%, transparent 70%);
      animation: shimmer 8s infinite;
    }
    
    @keyframes shimmer {
      0%, 100% { transform: translate(0,0); }
      50% { transform: translate(10%, 10%); }
    }
    
    .scene{
      min-height:400px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      text-align:center;
      padding:20px;
      position:relative;
      z-index:1;
    }
    
    .greeting{
      font-family:'Sacramento',cursive;
      color:var(--rose);
      font-size:3.5rem;
      margin:0 0 20px;
      opacity:0;
      transform:translateY(20px);
      animation:fadeSlideIn 0.8s forwards 0.3s;
      text-shadow: 2px 2px 4px rgba(212,86,127,0.1);
      line-height:1.2;
    }
    
    .sub{
      font-size:1.3rem;
      color:#5a3a4d;
      margin-bottom:20px;
      opacity:0;
      font-weight:400;
      line-height:1.6;
      animation:fadeSlideIn 0.8s forwards 0.5s;
    }
    
    .love-quote {
      font-family:'Cormorant Garamond',serif;
      font-style:italic;
      font-size:1.5rem;
      color:var(--deep-rose);
      margin:30px 0;
      padding:20px;
      border-left:3px solid var(--rose);
      border-right:3px solid var(--rose);
      opacity:0;
      animation:fadeSlideIn 0.8s forwards 0.6s;
      line-height:1.8;
    }
    
    @keyframes fadeSlideIn {
      to {
        opacity:1;
        transform:translateY(0);
      }
    }
    
    .nextHint{
      font-size:1rem;
      color:var(--rose);
      margin-top:30px;
      opacity:0;
      animation:pulse 2s infinite, fadeSlideIn 0.8s forwards 0.8s;
      font-style:italic;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.5; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }
    
    /* Gallery styles - Stacked Card Effect */
    .fileGallery{
      position:relative;
      min-height:500px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:60px 20px;
      margin-top:20px;
      perspective:1000px;
    }
    
    /* Single image display in center */
    .single-image-view {
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      min-height:500px;
      padding:40px 20px;
    }
    
    .single-image-container {
      background:#fff;
      border-radius:20px;
      padding:25px;
      box-shadow:0 20px 60px rgba(212,86,127,0.3);
      max-width:90%;
      opacity:0;
      transform:scale(0.9) translateY(30px);
      animation:singleImageAppear 0.6s forwards;
    }
    
    @keyframes singleImageAppear {
      to {
        opacity:1;
        transform:scale(1) translateY(0);
      }
    }
    
    .single-image-container img {
      width:100%;
      height:auto;
      max-height:450px;
      object-fit:contain;
      display:block;
      border-radius:12px;
      margin-bottom:20px;
    }
    
    .single-image-container.landscape img {
      max-width:550px;
      max-height:380px;
    }
    
    .single-image-container.portrait img {
      max-width:320px;
      max-height:500px;
    }
    
    .single-image-container .image-caption {
      font-family:'Cormorant Garamond',serif;
      font-style:italic;
      font-size:1.2rem;
      color:var(--deep-rose);
      text-align:center;
      line-height:1.6;
      padding:0 10px;
      opacity:0;
      animation:fadeSlideIn 0.5s forwards 0.3s;
    }
    
    /* --- POP IN / OUT ANIMATION (smooth) --- */
    @keyframes popIn {
      0% { transform: scale(0.88) translateY(28px); opacity: 0; filter: blur(6px); }
      60% { transform: scale(1.04) translateY(-6px); opacity: 1; filter: blur(0); }
      100% { transform: scale(1) translateY(0); opacity: 1; filter: none; }
    }
    @keyframes popOut {
      0% { transform: scale(1) translateY(0); opacity: 1; filter: none; }
      100% { transform: scale(0.9) translateY(24px); opacity: 0; filter: blur(4px); }
    }
    .single-image-container.pop-enter {
      animation: popIn var(--pop-duration) var(--pop-ease) forwards;
    }
    .single-image-container.pop-exit {
      animation: popOut 360ms ease forwards;
    }
    .single-image-container .image-caption { transition: opacity 300ms ease; }
    @media (prefers-reduced-motion: reduce) {
      .single-image-container.pop-enter,
      .single-image-container.pop-exit {
        animation: none !important;
        transition: none !important;
      }
    }
    /* --- end pop animations --- */

    .gallery-item {
      position:absolute;
      background:#fff;
      border-radius:20px;
      padding:20px;
      box-shadow:0 20px 60px rgba(212,86,127,0.25);
      opacity:0;
      transform:scale(0.8) translateY(50px);
      animation:cardStack 0.6s forwards;
      transition:transform 0.5s ease;
      max-width:90%;
    }
    
    /* Stagger the cards with different positions and rotations */
    .gallery-item:nth-child(1) { 
      animation-delay: 0.1s; 
      z-index:1;
      transform:rotate(-8deg) translateY(40px);
    }
    .gallery-item:nth-child(2) { 
      animation-delay: 0.2s; 
      z-index:2;
      transform:rotate(-4deg) translateY(20px);
    }
    .gallery-item:nth-child(3) { 
      animation-delay: 0.3s; 
      z-index:3;
      transform:rotate(0deg) translateY(0px);
    }
    .gallery-item:nth-child(4) { 
      animation-delay: 0.4s; 
      z-index:4;
      transform:rotate(4deg) translateY(-20px);
    }
    .gallery-item:nth-child(5) { 
      animation-delay: 0.5s; 
      z-index:5;
      transform:rotate(8deg) translateY(-40px);
    }
    .gallery-item:nth-child(6) { 
      animation-delay: 0.6s; 
      z-index:6;
      transform:rotate(-6deg) translateY(-60px);
    }
    
    @keyframes cardStack {
      to {
        opacity:1;
        transform:inherit;
      }
    }
    
    .gallery-item:hover {
      transform:scale(1.05) !important;
      z-index:100 !important;
      box-shadow:0 30px 80px rgba(212,86,127,0.35);
    }
    
    .gallery-item img{
      width:100%;
      height:auto;
      max-height:400px;
      object-fit:cover;
      display:block;
      border-radius:12px;
      margin-bottom:15px;
    }
    
    /* Landscape images */
    .gallery-item.landscape img {
      max-width:500px;
      max-height:350px;
    }
    
    /* Portrait images */
    .gallery-item.portrait img {
      max-width:300px;
      max-height:450px;
    }
    
    .image-caption {
      font-family:'Cormorant Garamond',serif;
      font-style:italic;
      font-size:1.1rem;
      color:var(--deep-rose);
      text-align:center;
      line-height:1.6;
      padding:0 10px;
    }
    
    /* Final page grid layout */
    .fileGallery.final-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
      gap:20px;
      padding:30px 0;
      margin-top:20px;
      min-height:auto;
      position:static;
      perspective:none;
    }
    
    .fileGallery.final-grid .gallery-item {
      position:static;
      transform:none !important;
      animation:galleryItemAppear 0.5s forwards;
      max-width:100%;
    }
    
    .fileGallery.final-grid .gallery-item:hover {
      transform:scale(1.05) !important;
    }
    
    @keyframes galleryItemAppear {
      to {
        opacity:1;
        transform:scale(1) rotate(0deg);
      }
    }
    
    .fileGallery.final-grid .gallery-item::before {
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:linear-gradient(135deg, transparent 0%, rgba(212,86,127,0.1) 100%);
      opacity:0;
      transition:opacity 0.3s;
      z-index:1;
      border-radius:20px;
    }
    
    .fileGallery.final-grid .gallery-item:hover::before {
      opacity:1;
    }
    
    .fileGallery.final-grid .gallery-item img{
      width:100%;
      height:300px;
      max-height:300px;
      max-width:100%;
      object-fit:cover;
      transition:transform 0.5s ease;
    }
    
    .fileGallery.final-grid .gallery-item:hover img {
      transform:scale(1.1);
    }
    
    .fileGallery.final-grid .image-caption {
      display:none;
    }
    
    /* Question buttons */
    .btnRow{
      display:flex;
      flex-direction:column;
      gap:20px;
      justify-content:center;
      margin-top:40px;
      opacity:0;
      animation:fadeSlideIn 0.8s forwards 0.3s;
    }
    
    .bigBtn{
      padding:18px 40px;
      border-radius:50px;
      border:none;
      font-weight:600;
      font-size:1.2rem;
      font-family:'Crimson Text',serif;
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:0 10px 30px rgba(0,0,0,0.1);
      position:relative;
      overflow:hidden;
    }
    
    .bigBtn::before {
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      width:0;
      height:0;
      border-radius:50%;
      background:rgba(255,255,255,0.3);
      transform:translate(-50%, -50%);
      transition:width 0.6s, height 0.6s;
    }
    
    .bigBtn:hover::before {
      width:300px;
      height:300px;
    }
    
    .yes{
      background:linear-gradient(135deg, var(--rose) 0%, var(--deep-rose) 100%);
      color:#fff;
      transform:scale(1);
    }
    
    .yes:hover{
      transform:scale(1.05) translateY(-2px);
      box-shadow:0 15px 40px rgba(212,86,127,0.4);
    }
    
    .ab{
      background:linear-gradient(135deg, #ffd1e0 0%, #ffb3d1 100%);
      color:var(--deep-rose);
      transform:scale(1);
    }
    
    .ab:hover{
      transform:scale(1.05) translateY(-2px);
      box-shadow:0 15px 40px rgba(255,179,209,0.4);
    }
    
    /* Audio controls */
    .audio-controls{
      position:fixed;
      right:20px;
      bottom:20px;
      padding:15px 20px;
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(10px);
      border:1px solid rgba(212,86,127,0.2);
      border-radius:50px;
      box-shadow:0 10px 30px rgba(212,86,127,0.2);
      display:flex;
      align-items:center;
      gap:12px;
      z-index:100;
      opacity:0;
      animation:fadeSlideIn 0.8s forwards 1.5s;
    }
    
    .audio-controls button {
      background:var(--rose);
      color:white;
      border:none;
      padding:8px 16px;
      border-radius:20px;
      cursor:pointer;
      font-family:'Crimson Text',serif;
      transition:all 0.3s;
    }
    
    .audio-controls button:hover {
      background:var(--deep-rose);
      transform:scale(1.05);
    }
    
    .audio-controls input[type="range"] {
      width:80px;
    }
    
    .audio-controls label {
      color:var(--deep-rose);
      font-size:0.9rem;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    /* Credit */
    .credit{
      font-size:1.1rem;
      color:var(--deep-rose);
      margin-top:30px;
      text-align:center;
      line-height:1.8;
      opacity:0;
      animation:fadeSlideIn 0.8s forwards 0.5s;
    }
    
    .credit div {
      margin:5px 0;
      font-style:italic;
    }
    
    /* Mascot */
    .mascot-wrap {
      position:absolute;
      right:30px;
      top:30px;
      opacity:0;
      animation:mascotBounce 1s forwards 1s, float 3s infinite ease-in-out 2s;
      font-size:50px;
      filter:drop-shadow(0 4px 8px rgba(212,86,127,0.2));
    }
    
    @keyframes mascotBounce {
      0% { opacity:0; transform:scale(0) rotate(-180deg); }
      60% { transform:scale(1.2) rotate(10deg); }
      100% { opacity:1; transform:scale(1) rotate(0deg); }
    }
    
    @keyframes float {
      0%, 100% { transform:translateY(0px) rotate(0deg); }
      50% { transform:translateY(-10px) rotate(5deg); }
    }
    
    /* Decorative elements */
    .deco-corner {
      position:absolute;
      width:100px;
      height:100px;
      opacity:0.1;
    }
    
    .deco-corner.top-left {
      top:20px;
      left:20px;
      border-top:3px solid var(--rose);
      border-left:3px solid var(--rose);
      border-radius:20px 0 0 0;
    }
    
    .deco-corner.bottom-right {
      bottom:20px;
      right:20px;
      border-bottom:3px solid var(--rose);
      border-right:3px solid var(--rose);
      border-radius:0 0 20px 0;
    }
    
    @media(max-width:768px){
      .greeting{ font-size:2.5rem; }
      .sub{ font-size:1.1rem; }
      .love-quote{ font-size:1.2rem; padding:15px; }
      .scene{ min-height:300px; padding:10px; }
      .card{ padding:30px 20px; }
      
      .single-image-view {
        min-height:400px;
        padding:30px 10px;
      }
      
      .single-image-container {
        padding:20px;
        max-width:95%;
      }
      
      .single-image-container img {
        max-height:400px;
      }
      
      .single-image-container.landscape img {
        max-width:100%;
        max-height:320px;
      }
      
      .single-image-container.portrait img {
        max-width:280px;
        max-height:420px;
      }
      
      .single-image-container .image-caption {
        font-size:1rem;
      }
      
      .fileGallery{ 
        min-height:400px;
        padding:40px 10px;
      }
      
      .gallery-item {
        max-width:85%;
      }
      
      .gallery-item.landscape img {
        max-width:100%;
        max-height:280px;
      }
      
      .gallery-item.portrait img {
        max-width:240px;
        max-height:380px;
      }
      
      .image-caption {
        font-size:1rem;
      }
      
      .fileGallery.final-grid{ 
        grid-template-columns:1fr; 
        gap:15px; 
      }
      
      .fileGallery.final-grid .gallery-item img{ 
        height:250px; 
      }
      
      .mascot-wrap{ font-size:35px; right:15px; top:15px; }
      .audio-controls{ right:10px; bottom:10px; padding:10px 15px; }
      .audio-controls label{ font-size:0.8rem; }
      .audio-controls input[type="range"]{ width:60px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <!-- Floating hearts background -->
  <div class="hearts-bg" id="heartsBg"></div>
  
  <div class="wrap">
    <div class="card" id="card">
      <div class="deco-corner top-left"></div>
      <div class="deco-corner bottom-right"></div>
      
      <div id="content">
        <div class="scene" id="scene">
          <div class="greeting" id="greeting">Loading‚Ä¶</div>
          <div class="sub" id="sub">Please wait</div>
          <div class="nextHint" id="hint">Tap to continue</div>
        </div>
      </div>
    </div>

    <div id="galleryWrap" style="display:none">
      <div class="fileGallery" id="gallery"></div>
    </div>

    <div class="credit" id="credit" style="display:none"></div>
  </div>

  <div id="audioWidget" class="audio-controls" style="display:none">
    <button id="playPauseBtn">‚ñ∂ Play</button>
    <label>Volume <input id="volume" type="range" min="0" max="1" step="0.05" value="0.6"></label>
  </div>

  <script>
    // Create floating hearts
    function createFloatingHearts() {
      const container = document.getElementById('heartsBg');
      const hearts = ['‚ô•', '‚ù§', 'üíï', 'üíó', 'üíñ'];
      for(let i = 0; i < 15; i++) {
        const heart = document.createElement('div');
        heart.className = 'heart-float';
        heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
        heart.style.left = Math.random() * 100 + '%';
        heart.style.animationDelay = Math.random() * 15 + 's';
        heart.style.fontSize = (15 + Math.random() * 20) + 'px';
        container.appendChild(heart);
      }
    }
    createFloatingHearts();

    function qsParam(name){ return new URLSearchParams(location.search).get(name); }
    function el(q){ return document.querySelector(q); }
    function createEl(tag, attrs){ const e = document.createElement(tag); for(const k in (attrs||{})) e.setAttribute(k, attrs[k]); return e; }

    const loveQuotes = [
      "In your eyes, I found my home",
      "Every love story is beautiful, but ours is my favorite",
      "You are my today and all of my tomorrows",
      "I love us",
      "Together is a wonderful place to be",
      "You're my person, my forever",
      "In a sea of people, my eyes will always search for you"
    ];

    (function(){
      const id = qsParam('share');
      const scene = el('#scene');
      const greetingEl = el('#greeting');
      const subEl = el('#sub');
      const hintEl = el('#hint');
      const galleryWrap = el('#galleryWrap');
      const gallery = el('#gallery');
      const credit = el('#credit');
      let share = null;
      let audioEl = null;
      let isPlaying = false;

      if (!id) {
        greetingEl.textContent = 'No share id';
        subEl.textContent = 'Missing share id in URL';
        hintEl.style.display = 'none';
        return;
      }

      const shareUrl = new URL(`./shares/${id}.json`, location.origin + location.pathname.replace(/\/[^\/]*$/,'/')).href;

      fetch(shareUrl).then(r=>{
        if (!r.ok) throw new Error('Share not found (HTTP ' + r.status + ')');
        return r.json();
      }).then(s => {
        share = s;
        startStory();
      }).catch(err => {
        console.error(err);
        greetingEl.textContent = 'Not published yet';
        subEl.textContent = 'Please try again in a minute or refresh';
        hintEl.style.display = 'none';
      });

      const steps = ['intro','quote1','images','question','final'];
      let stepIndex = 0;
      let currentImageIndex = 0;
      let imageFiles = [];

      function startStory(){
        const receiver = share.receiver || 'friend';
        greetingEl.textContent = `Hi ${receiver}!`;
        subEl.innerHTML = `This surprise was made especially for you ‚ù§Ô∏è`;
        hintEl.textContent = '‚ú® Tap to continue ‚ú®';

        // Store image files for later display
        if (share.files && share.files.length){
          const captions = [
            "This moment means everything",
            "You make my heart smile",
            "Forever grateful for you",
            "My favorite memory with you",
            "You are my happy place",
            "Every moment is better with you",
            "This is where my heart lives",
            "You complete my story"
          ];
          
          let captionIndex = 0;
          for (const f of share.files){
            if (f.url && /\.(jpe?g|png|gif|webp|svg|bmp)$/i.test(f.name)){
              imageFiles.push({
                url: f.url,
                name: f.name,
                caption: captions[captionIndex % captions.length]
              });
              captionIndex++;
            }
          }
        }

        if (share.background && share.background.url){
          setupAudioWidget(share.background.url, share.background.name);
          el('#audioWidget').style.display = 'flex';
        }

        renderMascot(share.theme || 'rabbit');

        scene.addEventListener('click', advance);
        let touchStartY = null;
        scene.addEventListener('touchstart', e => { touchStartY = e.touches[0].clientY; });
        scene.addEventListener('touchend', e => {
          const dy = (e.changedTouches[0].clientY - touchStartY);
          if (Math.abs(dy) > 30){
            advance();
          }
        });
      }

      function advance(){
        // If we're in images step and haven't shown all images yet
        if (steps[stepIndex] === 'images' && currentImageIndex < imageFiles.length) {
          showNextImage();
        } else {
          stepIndex = Math.min(stepIndex + 1, steps.length - 1);
          renderStep(steps[stepIndex]);
        }
      }

      function renderStep(step){
        hintEl.style.display = 'none';
        galleryWrap.style.display = 'none';
        
        switch(step){
          case 'quote1':
            scene.innerHTML = '';
            const quote1 = createEl('div');
            quote1.className = 'love-quote';
            quote1.textContent = `"${loveQuotes[Math.floor(Math.random() * loveQuotes.length)]}"`;
            scene.appendChild(quote1);
            hintEl.style.display = 'block';
            hintEl.textContent = '‚ú® Tap to continue ‚ú®';
            scene.appendChild(hintEl);
            break;

          case 'images':
            if (imageFiles.length > 0) {
              currentImageIndex = 0;
              showNextImage();
            } else {
              // Skip to question if no images
              stepIndex++;
              renderStep('question');
            }
            break;

          case 'question':
            scene.innerHTML = '';
            const qGreeting = createEl('div');
            qGreeting.className = 'greeting';
            qGreeting.textContent = 'Will you be my Valentine?';
            scene.appendChild(qGreeting);
            
            const qSub = createEl('div');
            qSub.className = 'love-quote';
            qSub.style.fontSize = '1.2rem';
            qSub.style.margin = '20px 0';
            qSub.textContent = '"Every day with you is Valentine\'s Day"';
            scene.appendChild(qSub);
            
            showQuestionCard();
            break;

          case 'final':
            showFinal();
            break;

          default:
            hintEl.style.display = 'block';
            hintEl.textContent = '‚ú® Tap to continue ‚ú®';
            break;
        }
      }

      // Helper: preload image and get orientation metadata
      function preloadImage(url) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = () => {
            resolve({ width: img.naturalWidth || img.width, height: img.naturalHeight || img.height, url });
          };
          img.onerror = (e) => reject(e);
          img.src = url;
        });
      }

      // Smooth showNextImage: preload, insert off-DOM, animate pop-in, animate old out
      async function showNextImage(){
        if (currentImageIndex >= imageFiles.length) return;

        const imageData = imageFiles[currentImageIndex];

        // preload image
        let meta;
        try {
          meta = await preloadImage(imageData.url);
        } catch (err) {
          console.warn('Image preload failed', err);
          meta = { width: 1000, height: 700, url: imageData.url };
        }

        // create new container off-DOM
        const newContainer = createEl('div');
        newContainer.className = 'single-image-container';
        if (meta.width > meta.height) newContainer.classList.add('landscape');
        else newContainer.classList.add('portrait');

        const img = createEl('img');
        img.src = meta.url;
        img.alt = imageData.name || '';

        const caption = createEl('div');
        caption.className = 'image-caption';
        caption.textContent = imageData.caption || '';

        newContainer.appendChild(img);
        newContainer.appendChild(caption);

        // capture any existing container to animate out
        const oldContainer = scene.querySelector('.single-image-container');

        // replace scene content with new wrapper to avoid layout jumps
        scene.innerHTML = '';
        const wrapper = createEl('div');
        wrapper.className = 'single-image-view';
        wrapper.appendChild(newContainer);
        scene.appendChild(wrapper);

        // force reflow then add enter class to trigger pop-in
        newContainer.offsetHeight; // force reflow
        newContainer.classList.add('pop-enter');

        currentImageIndex++;

        // attach hint below the image
        const hint = createEl('div');
        hint.className = 'nextHint';
        hint.textContent = currentImageIndex < imageFiles.length ? '‚ú® Tap for next moment ‚ú®' : '‚ú® Tap to continue ‚ú®';
        scene.appendChild(hint);

        // animate old container out if present (in case it exists from previous state)
        if (oldContainer) {
          // ensure old container has pop-exit animation
          oldContainer.classList.remove('pop-enter');
          oldContainer.classList.add('pop-exit');
          oldContainer.addEventListener('animationend', () => {
            try { if (oldContainer && oldContainer.parentNode) oldContainer.parentNode.removeChild(oldContainer); } catch(e){}
          }, { once: true });
        }

        // prefetch next image to warm cache (non-blocking)
        if (currentImageIndex < imageFiles.length) {
          const nextUrl = imageFiles[currentImageIndex].url;
          const p = new Image(); p.src = nextUrl;
        }
      }

      function showQuestionCard(){
        galleryWrap.style.display = 'none';
        const row = document.createElement('div');
        row.className = 'btnRow';
        const yes = document.createElement('button');
        yes.className = 'bigBtn yes'; 
        yes.innerHTML = 'YES ‚ù§Ô∏è';
        const ab = document.createElement('button');
        ab.className = 'bigBtn ab'; 
        ab.innerHTML = 'ABSOLUTELY YES üíñ';

        const existing = scene.querySelector('.btnRow');
        if (existing) existing.remove();
        scene.appendChild(row);
        row.appendChild(yes); 
        row.appendChild(ab);

        yes.addEventListener('click', () => { onAnswer('yes'); });
        ab.addEventListener('click', () => { onAnswer('absolutely'); });
      }

      function onAnswer(choice){
        // Multiple confetti bursts
        const duration = 3000;
        const end = Date.now() + duration;
        const colors = ['#d4567f','#ffd1e0','#ff5c8a','#fff2f6','#d4a574'];
        
        (function frame() {
          confetti({
            particleCount: 3,
            angle: 60,
            spread: 55,
            origin: { x: 0 },
            colors: colors
          });
          confetti({
            particleCount: 3,
            angle: 120,
            spread: 55,
            origin: { x: 1 },
            colors: colors
          });

          if (Date.now() < end) {
            requestAnimationFrame(frame);
          }
        }());
        
        setTimeout(()=>{ renderStep('final'); }, 3000);
      }

      function showFinal(){
        scene.innerHTML = '';
        galleryWrap.style.display = 'none';
        
        const title = document.createElement('div');
        title.className = 'greeting';
        title.textContent = 'With all my love';
        
        const quote = document.createElement('div');
        quote.className = 'love-quote';
        quote.textContent = '"You are my greatest adventure"';
        
        const line = document.createElement('div');
        line.className = 'sub';
        line.style.marginTop = '20px';
        line.textContent = share.message ? share.message : 'Forever grateful for you ‚ù§Ô∏è';
        
        scene.appendChild(title);
        scene.appendChild(quote);
        scene.appendChild(line);

        // Populate gallery for final display
        if (imageFiles.length > 0){
          gallery.innerHTML = '';
          imageFiles.forEach(imgData => {
            const item = createEl('div');
            item.className = 'gallery-item';
            
            const img = createEl('img'); 
            img.src = imgData.url; 
            img.alt = imgData.name;
            
            img.onload = function() {
              if (this.naturalWidth > this.naturalHeight) {
                item.classList.add('landscape');
              } else {
                item.classList.add('portrait');
              }
            };
            
            const caption = createEl('div');
            caption.className = 'image-caption';
            caption.textContent = imgData.caption;
            
            item.appendChild(img);
            item.appendChild(caption);
            gallery.appendChild(item);
          });
          
          gallery.classList.add('final-grid');
          galleryWrap.style.display = 'block';
        }

        const senderText = share.sender ? `Sent with all my heart by ${share.sender}` : '';
        const receiverText = share.receiver ? `For my dearest ${share.receiver}` : '';
        credit.style.display = 'block';
        credit.innerHTML = `<div>${senderText}</div><div>${receiverText}</div><div style="margin-top:10px;font-size:0.9rem;">‚ù§Ô∏è Happy Valentine's Day ‚ù§Ô∏è</div>`;
      }

      function setupAudioWidget(url, name){
        audioEl = document.createElement('audio');
        audioEl.src = url;
        audioEl.loop = true;
        audioEl.preload = 'auto';
        audioEl.volume = 0.6;
        audioEl.crossOrigin = 'anonymous';
        audioEl.style.display = 'none';
        document.body.appendChild(audioEl);

        const playBtn = el('#playPauseBtn');
        const volume = el('#volume');

        audioEl.play().then(()=>{
          isPlaying = true;
          playBtn.textContent = '‚è∏ Pause';
        }).catch((err)=>{
          isPlaying = false;
        });

        const startOnGesture = async () => {
          if (!audioEl) return;
          if (!isPlaying){
            try {
              await audioEl.play();
              isPlaying = true;
              playBtn.textContent = '‚è∏ Pause';
            } catch (e) {
              console.warn('Play on gesture failed', e);
            }
          }
          document.removeEventListener('click', startOnGesture);
        };
        document.addEventListener('click', startOnGesture, { once: true });

        playBtn.addEventListener('click', async () => {
          if (!audioEl) return;
          if (isPlaying){
            audioEl.pause();
            isPlaying = false;
            playBtn.textContent = '‚ñ∂ Play';
          } else {
            try {
              await audioEl.play();
              isPlaying = true;
              playBtn.textContent = '‚è∏ Pause';
            } catch (err) {
              console.error('Playback failed', err);
              alert('Playback blocked. Please interact with the page or try again.');
            }
          }
        });

        volume.addEventListener('input', () => {
          audioEl.volume = Number(volume.value);
        });
      }

      function renderMascot(theme){
        const mascotWrap = document.createElement('div');
        mascotWrap.className = 'mascot-wrap';
        
        if (theme === 'hamster'){
          mascotWrap.textContent = 'üêπ';
        } else if (theme === 'rabbit'){
          mascotWrap.textContent = 'üê∞';
        } else {
          mascotWrap.textContent = 'üíñ';
        }
        
        const card = el('#card');
        card.appendChild(mascotWrap);
      }

    })();
  </script>
</body>
</html>
