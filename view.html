<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>View shared assets</title>
  <style>
    body{font-family:system-ui,Arial;margin:20px;max-width:960px}
    img{max-width:100%;height:auto;margin:8px 0}
    .item{margin-bottom:12px}
    .meta{font-size:0.9rem;color:#555}
    .audio-controls{position:fixed;right:12px;bottom:12px;padding:10px;background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
    .audio-controls button{margin-left:8px}
  </style>
</head>
<body>
  <h1>Shared assets</h1>
  <div id="content">Loading…</div>

  <div id="audioWidget" style="display:none" class="audio-controls" aria-hidden="true">
    <span id="audioStatus">Loading music…</span>
    <button id="playPauseBtn">Play</button>
    <label style="margin-left:8px">Volume
      <input id="volume" type="range" min="0" max="1" step="0.05" value="0.6">
    </label>
  </div>

  <script>
    function qsParam(name){
      const params = new URLSearchParams(location.search);
      return params.get(name);
    }

    (function(){
      const content = document.getElementById('content');
      const id = qsParam('share');
      if (!id) { content.innerHTML = '<p>No share id.</p>'; return; }

      const shareUrl = new URL(`./shares/${id}.json`, location.origin + location.pathname.replace(/\/[^\/]*$/,'/')).href;
      fetch(shareUrl)
        .then(r => {
          if (!r.ok) throw new Error('Share not found (HTTP ' + r.status + ')');
          return r.json();
        })
        .then(share => renderShare(share))
        .catch(err => {
          console.error(err);
          content.innerHTML = '<p>Share not found yet. Please try again in a minute or refresh.</p>';
        });

      let audioEl = null;
      let isPlaying = false;

      function renderShare(share){
        content.innerHTML = '';
        // Render files
        if (share.files && share.files.length) {
          for (const f of share.files) {
            const wrap = document.createElement('div'); wrap.className = 'item';
            if (f.name && /\.(jpe?g|png|gif|webp|svg|bmp)$/i.test(f.name)) {
              const img = document.createElement('img'); img.src = f.url; wrap.appendChild(img);
            } else if (f.name && /\.(mp3|wav|ogg|m4a)$/i.test(f.name)) {
              const a = document.createElement('audio'); a.controls = true; a.src = f.url; wrap.appendChild(a);
            } else {
              const a = document.createElement('a'); a.href = f.url; a.textContent = f.name || f.url; a.target = '_blank'; wrap.appendChild(a);
            }

            const meta = document.createElement('div'); meta.className = 'meta';
            const dl = document.createElement('a'); dl.href = f.url; dl.download = f.name || '';
            dl.textContent = 'Download';
            meta.appendChild(document.createTextNode((f.name ? f.name + ' ' : '') + '(' + (f.url || '') + ') '));
            meta.appendChild(dl);
            wrap.appendChild(meta);
            content.appendChild(wrap);
          }
        } else {
          content.innerHTML = '<p>No files in share.</p>';
        }

        // Setup background music if provided
        if (share.background && share.background.url) {
          setupBackgroundAudio(share.background.url, share.background.name || '');
        }
      }

      function setupBackgroundAudio(url, name){
        // create audio element (hidden controls); we will manage UI separately
        audioEl = document.createElement('audio');
        audioEl.src = url;
        audioEl.loop = true;
        audioEl.volume = 0.6;
        audioEl.preload = 'auto';
        audioEl.crossOrigin = 'anonymous';

        const widget = document.getElementById('audioWidget');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const audioStatus = document.getElementById('audioStatus');
        const volume = document.getElementById('volume');

        audioStatus.textContent = (name ? name + ' • ' : '') + 'Background music';
        widget.style.display = 'block';
        widget.setAttribute('aria-hidden', 'false');

        // Try to autoplay — many browsers block autoplay with sound; catch the error and show Play button
        audioEl.play().then(() => {
          isPlaying = true;
          playPauseBtn.textContent = 'Pause';
        }).catch((err) => {
          // Autoplay blocked — show Play button for user gesture
          isPlaying = false;
          playPauseBtn.textContent = 'Play';
          console.warn('Autoplay blocked:', err);
        });

        playPauseBtn.addEventListener('click', async () => {
          if (!audioEl) return;
          if (isPlaying) {
            audioEl.pause();
            isPlaying = false;
            playPauseBtn.textContent = 'Play';
          } else {
            try {
              await audioEl.play();
              isPlaying = true;
              playPauseBtn.textContent = 'Pause';
            } catch (err) {
              console.error('Play failed:', err);
              alert('Playback blocked by browser. Please interact with the page and try again.');
            }
          }
        });

        volume.addEventListener('input', () => {
          audioEl.volume = Number(volume.value);
        });

        // Start muted autoplay trick (optional): try play muted first to improve UX,
        // then unmute after user gesture. Many browsers allow muted autoplay.
        // Here we don't force mute — we attempted normal play above.

        // attach audio element to DOM but keep it visually hidden
        audioEl.style.display = 'none';
        document.body.appendChild(audioEl);
      }
    })();
  </script>
</body>
</html>
