<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload — Save to GitHub</title>
  <style>
    body{font-family:system-ui,Arial;margin:20px;max-width:900px}
    .file-list{margin:10px 0;padding:0;list-style:none}
    .file-list li{margin:6px 0;padding:6px;border:1px solid #eee;border-radius:6px}
    .controls{margin-top:12px}
    button[disabled]{opacity:0.6}
    label.block{display:block;margin:10px 0}
  </style>
</head>
<body>
  <h1>Upload files — Save to GitHub</h1>
  <p>Select images/documents using the first input and (optionally) one audio file for background music using the audio input below.</p>

  <label class="block">Files (images, docs, etc, multiple):
    <input id="files" type="file" multiple accept="image/*,application/pdf,image/*,text/*">
  </label>

  <label class="block">Background audio (optional, single file):
    <input id="audioFile" type="file" accept="audio/*">
  </label>

  <label style="display:block;margin-bottom:12px">
    <input id="useAsBg" type="checkbox"> Use selected audio as background music in the viewer
  </label>

  <div id="filePreview"></div>

  <p><button id="upload">Upload & create share</button></p>

  <h3>Result</h3>
  <div id="result">No upload yet</div>

  <script>
    // Change this if your Render URL is different
    const serverUrl = "https://uploader-server-h3iz.onrender.com";

    const filesInput = document.getElementById('files');
    const audioInput = document.getElementById('audioFile');
    const useAsBg = document.getElementById('useAsBg');
    const filePreview = document.getElementById('filePreview');
    const uploadBtn = document.getElementById('upload');
    const resDiv = document.getElementById('result');

    let selectedFiles = [];
    let selectedAudio = null;

    filesInput.addEventListener('change', () => {
      selectedFiles = Array.from(filesInput.files || []);
      renderFileList();
    });

    audioInput.addEventListener('change', () => {
      selectedAudio = audioInput.files && audioInput.files[0] ? audioInput.files[0] : null;
      renderFileList();
    });

    function renderFileList(){
      const parts = [];
      if (!selectedFiles.length && !selectedAudio){
        filePreview.innerHTML = '<p>No files selected.</p>';
        return;
      }
      const ul = document.createElement('ul');
      ul.className = 'file-list';
      selectedFiles.forEach(f => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${escapeHtml(f.name)}</strong> — ${(f.size/1024).toFixed(1)} KB`;
        ul.appendChild(li);
      });
      if (selectedAudio){
        const li = document.createElement('li');
        li.innerHTML = `<strong>Audio: ${escapeHtml(selectedAudio.name)}</strong> — ${(selectedAudio.size/1024).toFixed(1)} KB`;
        ul.appendChild(li);
      }
      filePreview.innerHTML = '';
      filePreview.appendChild(ul);
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    uploadBtn.addEventListener('click', async () => {
      if (!selectedFiles.length && !selectedAudio) return alert('Choose one or more files or an audio file.');

      const fd = new FormData();
      for (const f of selectedFiles) fd.append('files', f, f.name);
      if (selectedAudio){
        fd.append('files', selectedAudio, selectedAudio.name);
        if (useAsBg.checked){
          fd.append('bg', selectedAudio.name);
        }
      }

      uploadBtn.disabled = true;
      resDiv.textContent = 'Uploading and publishing… This can take up to 30s. Please wait.';

      try {
        const resp = await fetch(serverUrl.replace(/\/$/, '') + '/upload', { method: 'POST', body: fd });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || JSON.stringify(data));
        resDiv.innerHTML = '<p>Share URL (copy and give to recipients):</p>' +
          `<p><a href="${data.pagesURL}" target="_blank">${data.pagesURL}</a></p>` +
          `<pre>${JSON.stringify(data.share, null, 2)}</pre>`;
      } catch (err) {
        console.error(err);
        resDiv.innerHTML = '<p>Upload failed: ' + (err.message || err) + '</p>' +
          '<p><button id="retry">Retry</button></p>';
        document.getElementById('retry').addEventListener('click', () => location.reload());
      } finally {
        uploadBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
